<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronCity - Profesyonel Panel</title>
    <style>
        /* --- TASARIM (CSS) --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #e0e0e0; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .container { background-color: #1e1e1e; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); width: 650px; max-width: 95%; }
        h2 { color: #00e676; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        h3 { color: #29b6f6; margin-top: 20px; font-size: 1.1em; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #333; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; resize: vertical; }
        
        button { width: 100%; padding: 12px; background-color: #00e676; color: #000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        button:hover { background-color: #00c853; }
        button.logout { background-color: #ff5252; color: white; margin-top: 20px; }
        button.logout:hover { background-color: #d32f2f; }
        
        .admin-panel { border: 1px solid #29b6f6; padding: 15px; border-radius: 8px; margin-top: 20px; background: #1a2733; }
        .uyari { color: #ff5252; font-size: 0.9em; margin-top: 5px; text-align: center; }
        
        .saat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .saat-kutusu { background: #333; padding: 15px; text-align: center; border-radius: 6px; cursor: pointer; border: 1px solid #444; position: relative; }
        .saat-kutusu span { display: block; font-size: 0.8em; color: #888; }
        .saat-kutusu:hover { background: #444; }
        
        /* Durum Renkleri */
        .saat-kutusu.secili { background-color: #00e676; color: black; border-color: #00e676; }
        .saat-kutusu.benim { background-color: #29b6f6; color: white; border-color: #29b6f6; }
        .saat-kutusu.dolu { background-color: #b71c1c; color: #ffcdd2; cursor: not-allowed; opacity: 0.7; }
        .saat-kutusu.open-gym { background-color: #3f51b5; color: white; border-color: #3f51b5; cursor: not-allowed; }
        
        .hidden { display: none !important; }

        /* Admin Ayar D√ºzeni */
        .admin-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;}
        #bookingDetails { background: #2a2a2a; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto;}

        /* Haftalƒ±k Program (Collapsible) Stilleri */
        #weeklyScheduleContainer { margin-top: 10px; border-top: 1px solid #333; padding-top: 15px; }
        .schedule-day { 
            margin-bottom: 10px; 
            border: 1px solid #333; 
            border-radius: 6px;
            background: #2a2a2a;
        }
        .schedule-day summary { 
            padding: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            outline: none;
            list-style: none;
        }
        .schedule-day summary::marker { 
            content: "+";
        }
        .schedule-day[open] summary::marker {
            content: "‚àí"; 
        }
        .schedule-slots { 
            padding: 10px; 
            border-top: 1px solid #333;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .schedule-slots select { 
            width: 100%; 
            margin: 0; 
        }

        .membership-info {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 25px;
            border-left: 5px solid #00e676;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        .membership-info span {
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="loginScreen">
            <h2>IronCity Giri≈ü</h2>
            <p style="text-align:center; font-size:0.9em; color:#888;">√úyeliƒüiniz yoksa salon y√∂netimi ile g√∂r√º≈ü√ºn.</p>
            <input type="email" id="loginEmail" placeholder="E-Posta">
            <input type="password" id="loginPass" placeholder="≈ûifre">
            <button id="loginBtn">Giri≈ü Yap</button>
            <p id="loginError" class="uyari"></p>
        </div>

        <div id="mainPanel" class="hidden">
            <h2 id="welcomeText">Ho≈ügeldiniz</h2>
            
            <div id="adminControls" class="admin-panel hidden">
                <h3 style="margin-top:0">üõ†Ô∏è Y√∂netici Paneli</h3>
                
                <div class="admin-section">
                    <div>
                        <h4>1. Genel Ayarlar</h4>
                        <label>Salon Kapasitesi (Ki≈üi):</label>
                        <input type="number" id="adminKapasite" min="1">
                        
                        <label>A√ßƒ±lƒ±≈ü Saati:</label>
                        <input type="time" id="openTime" value="09:00">
                        
                        <label>Kapanƒ±≈ü Saati:</label>
                        <input type="time" id="closeTime" value="22:00">
                    </div>

                    <div>
                        <h4>2. √úyelik S√ºresi Y√∂netimi</h4>
                        <label>√úye E-Postasƒ±:</label>
                        <input type="email" id="uyeEmailAdmin" placeholder="√úye E-Postasƒ± (√∂rnek@mail.com)">
                        
                        <label>Yeni Biti≈ü Tarihi:</label>
                        <input type="date" id="uyeBitisTarihiAdmin">
                        
                        <button id="uyeGuncelleBtn" style="background:#29b6f6; color:white;">√úye S√ºresini G√ºncelle</button>
                    </div>
                </div>

                <div id="weeklyScheduleContainer">
                    <h4>3. Haftalƒ±k Program Ayarlarƒ± (Kompakt G√∂r√ºn√ºm)</h4>
                    <p style="font-size:0.8em; color:#aaa;">(Hangi saatlerin VOD/Open GYM olacaƒüƒ±nƒ± belirler.)</p>
                    
                    <div id="scheduleAccordion">
                        </div>

                    <button id="ayarGuncelleBtn" style="background:#29b6f6; color:white;">T√ºm Ayarlarƒ± Kaydet</button>
                </div>

                <hr style="border-color:#333; margin:15px 0;">
                
                <div>
                    <h4>4. G√ºnl√ºk VOD Program Notu (Bug√ºn)</h4>
                    <p style="font-size:0.8em; color:#aaa;">(Rezervasyon alanƒ±nƒ±n √ºzerinde g√∂r√ºnecek antrenman notudur. Alt satƒ±rlar otomatik algƒ±lanƒ±r.)</p>
                    <textarea id="wodInputAdmin" placeholder="√ñrn: Bug√ºn WOD: 5 Raund - 10 Burpee, 15 Squat, 20 KB Swing"></textarea>
                    <button id="wodKaydetBtn" style="background:#00e676; color:black;">VOD Notunu Kaydet</button>
                </div>

                <hr style="border-color:#333; margin:15px 0;">

                <div>
                    <h4>5. Randevu Listeleme</h4>
                    <label>G√∂r√ºnt√ºlenecek Tarihi Se√ß:</label>
                    <input type="date" id="bookingDateAdmin">
                    <button id="showBookingsBtn">Randevularƒ± G√∂r√ºnt√ºle</button>
                    <p style="font-size:0.9em; margin-top:10px;">Katƒ±lƒ±mcƒ±lar:</p>
                    <div id="bookingDetails">Randevu detaylarƒ± burada listelenecek.</div>
                </div>

                <hr style="border-color:#333; margin:15px 0;">
                
                <div>
                    <h4>6. Yeni √úyelik A√ßma</h4>
                    <p style="font-size:0.8em; color:#aaa;">(Yeni bir kullanƒ±cƒ± hesabƒ± ve √ºyelik kaydƒ± olu≈üturur. ƒ∞≈ülem sonrasƒ± Admin'in tekrar giri≈ü yapmasƒ± gerekir.)</p>
                    <input type="email" id="newUyeEmail" placeholder="Yeni √úye E-Postasƒ±" autocomplete="off">
                    <input type="password" id="newUyePass" placeholder="≈ûifre (Min 6 karakter)">
                    <label style="margin-top:10px; display:block;">√úyelik Biti≈ü Tarihi:</label>
                    <input type="date" id="newUyeBitisTarihi">
                    <button id="yeniUyelikAcBtn" style="background:#ff9800; color:black;">Yeni √úyelik Olu≈ütur</button>
                    <p id="uyeOlusturmaDurum" class="uyari" style="color:yellow;"></p>
                </div>

            </div>

            <div id="bookingArea">
                <h3>üìÖ Antrenman Saati Se√ß (Bug√ºn: <span id="bugunTarih"></span>)</h3>
                <p id="wodDisplay" style="color:#00e676; font-weight:bold; margin-top:10px;"></p>
                
                <p id="statusMsg" style="font-size:0.9em; color:#aaa;">M√ºsait saatler y√ºkleniyor...</p>
                
                <div class="saat-grid" id="saatListesi">
                    </div>

                <button id="randevuBtn">Se√ßili Saati Ayƒ±rt</button>
            </div>
            
            <div class="membership-info">
                <span>
                    ƒ∞lk √úyelik Tarihi: <strong id="baslangicTarihiDisplay">Y√ºkleniyor...</strong>
                </span>
                <span>
                    √úyelik Biti≈ü Tarihi: <strong id="bitisTarihiDisplay">Y√ºkleniyor...</strong>
                </span>
            </div>
            
            <button class="logout" id="cikisBtn">G√ºvenli √áƒ±kƒ±≈ü</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- AYARLAR ---
        const firebaseConfig = {
            // ‚ö†Ô∏è BURAYA KENDƒ∞ PROJE Bƒ∞LGƒ∞LERƒ∞Nƒ∞ YAPI≈ûTIR!
            apiKey: "AIzaSyCb5UEAdIvmPz2cvfVg2Hd54rLt79_Kf20",
  authDomain: "sporsalonuapp-547cb.firebaseapp.com",
  projectId: "sporsalonuapp-547cb",
  storageBucket: "sporsalonuapp-547cb.firebasestorage.app",
  messagingSenderId: "601776205922",
  appId: "1:601776205922:web:a8df55bdb39188eca8613b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global Deƒüi≈ükenler
        let currentUser = null;
        let userRole = "uye";
        let salonKapasitesi = 5;
        let openTime = "09:00";
        let closeTime = "22:00";
        let secilenSaat = null;
        let weeklySchedule = {};
        
        const today = new Date();
        let bugunStr = today.toISOString().split('T')[0];
        const gunler = ["Pazar", "Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma", "Cumartesi"];
        
        // Ba≈ülangƒ±√ß
        document.getElementById('bugunTarih').innerText = bugunStr;
        
        // --- YARDIMCI FONKSƒ∞YONLAR ---

        const timeToMinutes = (time) => {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        };

        const generateTimeSlots = (start, end, interval = 60) => {
            let slots = [];
            let current = timeToMinutes(start);
            const endMinutes = timeToMinutes(end);
            
            while (current < endMinutes) {
                const h = Math.floor(current / 60);
                const m = current % 60;
                slots.push(`${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
                current += interval;
            }
            return slots;
        };

        // Admin Panelinde Haftalƒ±k Program Ayarlarƒ±nƒ± Collapsible olarak √áizer
        function renderAdminSchedule() {
            const container = document.getElementById('scheduleAccordion');
            container.innerHTML = '';
            const allSlots = generateTimeSlots(openTime, closeTime);

            gunler.forEach((gun, gunIndex) => {
                const daySchedule = weeklySchedule[gunIndex] || {}; 
                
                const details = document.createElement('details');
                details.className = 'schedule-day';
                details.innerHTML = `<summary>${gun} Programƒ±</summary>`;
                
                const slotsDiv = document.createElement('div');
                slotsDiv.className = 'schedule-slots';
                
                allSlots.forEach(slot => {
                    const currentType = daySchedule[slot] || 'VOD'; 
                    
                    slotsDiv.innerHTML += `
                        <div>
                            <label>${slot}:</label>
                            <select id="schedule-${gunIndex}-${slot}" data-day="${gunIndex}" data-time="${slot}">
                                <option value="VOD" ${currentType === 'VOD' ? 'selected' : ''}>VOD (Rezerv Edilebilir)</option>
                                <option value="OPEN_GYM" ${currentType === 'OPEN_GYM' ? 'selected' : ''}>Open GYM</option>
                                <option value="CLOSED" ${currentType === 'CLOSED' ? 'selected' : ''}>KAPALI</option>
                            </select>
                        </div>
                    `;
                });
                
                details.appendChild(slotsDiv);
                container.appendChild(details);
            });
        }


        // --- ANA FONKSƒ∞YONLAR ---

        // 1. OTURUM KONTROL√ú
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await kullaniciVerileriniCek(user.uid);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainPanel').classList.remove('hidden');
                document.getElementById('welcomeText').innerText = "Ho≈ügeldin, " + user.email;
                
                verileriDinle();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainPanel').classList.add('hidden');
            }
        });

        // 2. KULLANICI VERƒ∞LERƒ∞Nƒ∞ VE ROL√úN√ú √áEKME (√úyelik Bilgilerini G√∂sterme Eklendi)
        async function kullaniciVerileriniCek(uid) {
            const docRef = doc(db, "uyeler", uid);
            const docSnap = await getDoc(docRef);

            let baslangicTarihi = "Belirtilmemi≈ü";
            let bitisTarihi = "Belirtilmemi≈ü";

            // Eƒüer uyeler belgesi varsa, rol√º ve √ºyelik s√ºresini kontrol et
            if (docSnap.exists()) {
                const data = docSnap.data();
                userRole = data.rol || "uye"; // Rol yoksa varsayƒ±lanƒ± 'uye'
                
                baslangicTarihi = data.uyelikBaslangicTarihi || "Belirtilmemi≈ü";
                bitisTarihi = data.uyelikBitisTarihi || "Belirtilmemi≈ü";
                
                // √úyelik Biti≈ü Tarihi Kontrol√º
                if (userRole !== 'admin' && bitisTarihi < bugunStr) {
                    alert("‚ö†Ô∏è √úyeliƒüinizin s√ºresi dolmu≈ü! L√ºtfen y√∂netimle g√∂r√º≈ü√ºn.");
                    signOut(auth);
                    return;
                }
            } else {
                // Eƒüer uyeler belgesi yoksa, kesinlikle admin deƒüildir.
                userRole = "uye";
            }
            
            // --- √úyelik Bilgilerini Aray√ºze Yaz ---
            document.getElementById('baslangicTarihiDisplay').innerText = baslangicTarihi;
            document.getElementById('bitisTarihiDisplay').innerText = bitisTarihi;


            // --- Admin Paneli G√∂r√ºn√ºrl√ºƒü√ºn√º Y√∂netme ---
            if (userRole === 'admin') {
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('bookingDateAdmin').value = bugunStr;
            } else {
                // Admin deƒüilse, paneli KESƒ∞NLƒ∞KLE Gƒ∞ZLE
                document.getElementById('adminControls').classList.add('hidden');
            }
        }

        // 3. CANLI VERƒ∞ AKI≈ûI (AYARLAR VE RANDEVULAR)
        function verileriDinle() {
            onSnapshot(doc(db, "ayarlar", "genel"), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    salonKapasitesi = data.kapasite || 5;
                    openTime = data.openTime || "09:00";
                    closeTime = data.closeTime || "22:00";
                    weeklySchedule = data.weeklySchedule || {};
                    
                    if(userRole === 'admin') {
                        document.getElementById('adminKapasite').value = salonKapasitesi;
                        document.getElementById('openTime').value = openTime;
                        document.getElementById('closeTime').value = closeTime;
                        renderAdminSchedule(); // Admin Panelini Yenile
                    }
                }
            });

            // Randevular (ve Program Notu) dinleniyor
            onSnapshot(doc(db, "randevular", bugunStr), (docSnap) => {
                let doluVeriler = {};
                let programNotu = ""; 
                
                if (docSnap.exists()) {
                    doluVeriler = docSnap.data();
                    programNotu = docSnap.data().programNotu || ""; // G√ºnl√ºk WOD Programƒ±nƒ± al
                }
                
                saatleriCiz(doluVeriler, programNotu); 
                
                // ADMIN: Eƒüer admin ise, WOD notunu d√ºzenleme alanƒ±na y√ºkle
                if (userRole === 'admin') {
                    const wodInput = document.getElementById('wodInputAdmin');
                    if(wodInput) wodInput.value = programNotu;
                }
            });
        }

        // 4. SAATLERƒ∞ OLU≈ûTURMA (WOD NOTU VE SATIR SONU D√úZELTMESƒ∞ YAPILDI)
        function saatleriCiz(doluVeriler, programNotu = "") {
            const grid = document.getElementById('saatListesi');
            grid.innerHTML = "";
            
            const musaitSaatler = generateTimeSlots(openTime, closeTime);
            const bugunGunIndex = today.getDay();
            
            // WOD Programƒ±nƒ± G√∂ster
            const tarihText = document.getElementById('bugunTarih').innerText;
            const wodDisplay = document.getElementById('wodDisplay');

            // Alt satƒ±r karakterini (<br>) ile deƒüi≈ütirme (Kullanƒ±cƒ± Paneli)
            const formattedProgramNotu = programNotu.replace(/\n/g, '<br>');
            
            if (formattedProgramNotu.trim() !== "") {
                wodDisplay.innerHTML = `(${tarihText}) VOD Programƒ±: <strong>${formattedProgramNotu}</strong>`;
            } else {
                wodDisplay.innerHTML = `(${tarihText}) VOD Programƒ±: <strong>Hen√ºz belirlenmedi.</strong>`;
            }


            let reservableFound = false;

            musaitSaatler.forEach(saat => {
                const div = document.createElement('div');
                div.className = 'saat-kutusu';

                const slotType = (weeklySchedule[bugunGunIndex] && weeklySchedule[bugunGunIndex][saat]) || 'CLOSED';
                
                const katilimcilar = doluVeriler[saat] || [];
                const dolulukOrani = katilimcilar.length;
                const benVarMiyim = katilimcilar.includes(currentUser.uid);

                if (slotType === 'VOD') {
                    reservableFound = true;
                    div.innerHTML = `<b>VOD - ${saat}</b><span>${dolulukOrani} / ${salonKapasitesi} Dolu</span>`;

                    if (benVarMiyim) {
                        div.classList.add('benim');
                        div.innerHTML += "‚úÖ";
                        div.onclick = () => randevuIptalEt(saat);
                    } else if (dolulukOrani >= salonKapasitesi) {
                        div.classList.add('dolu');
                        div.innerHTML += "‚õî";
                        div.onclick = null;
                    } else {
                        div.onclick = () => {
                            document.querySelectorAll('.saat-kutusu').forEach(k => k.classList.remove('secili'));
                            div.classList.add('secili');
                            secilenSaat = saat;
                        };
                    }

                } else if (slotType === 'OPEN_GYM') {
                    div.classList.add('open-gym');
                    div.innerHTML = `<b>OPEN GYM - ${saat}</b><span>Rezerve Edilemez</span>`;
                    div.onclick = null;

                } else { // CLOSED
                    div.classList.add('dolu');
                    div.innerHTML = `<b>KAPALI - ${saat}</b><span>Kapalƒ±dƒ±r</span>`;
                    div.onclick = null;
                }
                
                grid.appendChild(div);
            });
            
            document.getElementById('randevuBtn').disabled = !reservableFound;

            if (!reservableFound && musaitSaatler.length > 0) {
                 document.getElementById('statusMsg').innerText = "Bug√ºn rezerve edilebilir VOD saatleri bulunmamaktadƒ±r.";
            } else if (musaitSaatler.length === 0) {
                 document.getElementById('statusMsg').innerText = "Salonun √ßalƒ±≈üma saatleri ayarlanmamƒ±≈ütƒ±r.";
            } else {
                 document.getElementById('statusMsg').innerText = "M√ºsait saatleri se√ßin.";
            }
        }

        // 5. RANDEVU ALMA ƒ∞≈ûLEMƒ∞
        async function randevuAl() {
            if (!secilenSaat) return alert("L√ºtfen bir saat se√ßin.");
            
            const bugunGunIndex = today.getDay();
            const slotType = (weeklySchedule[bugunGunIndex] && weeklySchedule[bugunGunIndex][secilenSaat]) || 'CLOSED';

            if (slotType !== 'VOD') {
                return alert("‚ùå Bu saat VOD deƒüildir ve rezerve edilemez.");
            }
            
            const mevcutRandevu = document.querySelector('.saat-kutusu.benim');
            if (mevcutRandevu) {
                return alert("‚ùå G√ºnde sadece 1 randevu alabilirsiniz! √ñnce mevcut randevunuzu iptal edin.");
            }

            const randevuRef = doc(db, "randevular", bugunStr);
            
            const docSnap = await getDoc(randevuRef);
            let mevcutListe = [];
            if(docSnap.exists() && docSnap.data()[secilenSaat]) {
                mevcutListe = docSnap.data()[secilenSaat];
            }

            if(mevcutListe.length >= salonKapasitesi) {
                return alert("√úzg√ºn√ºm, bu VOD saati az √∂nce doldu!");
            }

            await setDoc(randevuRef, {
                [secilenSaat]: arrayUnion(currentUser.uid)
            }, { merge: true });

            alert("VOD randevusu alƒ±ndƒ±! üí™");
            secilenSaat = null;
        }

        // 6. RANDEVU ƒ∞PTAL
        async function randevuIptalEt(saat) {
            if(!confirm(`${saat} randevunu iptal etmek istiyor musun?`)) return;

            const randevuRef = doc(db, "randevular", bugunStr);
            await updateDoc(randevuRef, {
                [saat]: arrayRemove(currentUser.uid)
            });
        }

        // 7. FONKSƒ∞YONLAR (Login, Admin ƒ∞≈ülemleri)
        async function girisYap() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                document.getElementById('loginError').innerText = "Hata: " + e.message;
            }
        }

        function cikisYap() { 
            signOut(auth);
        }

        // ADMIN: Ayarlarƒ± G√ºncelle
        async function ayarGuncelle() {
            const yeniKapasite = Number(document.getElementById('adminKapasite').value);
            const yeniOpenTime = document.getElementById('openTime').value;
            const yeniCloseTime = document.getElementById('closeTime').value;
            
            const newWeeklySchedule = {};
            const allSelects = document.querySelectorAll('#scheduleAccordion select');
            
            allSelects.forEach(select => {
                const dayIndex = select.dataset.day;
                const time = select.dataset.time;
                const type = select.value;

                if (!newWeeklySchedule[dayIndex]) {
                    newWeeklySchedule[dayIndex] = {};
                }
                newWeeklySchedule[dayIndex][time] = type;
            });


            await setDoc(doc(db, "ayarlar", "genel"), { 
                kapasite: yeniKapasite,
                openTime: yeniOpenTime,
                closeTime: yeniCloseTime,
                weeklySchedule: newWeeklySchedule
            }, { merge: true });

            alert("T√ºm Ayarlar ve Haftalƒ±k Program g√ºncellendi!");
        }

        // ADMIN: G√ºnl√ºk VOD Program Notunu Kaydet
        async function wodKaydet() {
            const wodText = document.getElementById('wodInputAdmin').value.trim();
            const randevuRef = doc(db, "randevular", bugunStr);

            await setDoc(randevuRef, {
                programNotu: wodText
            }, { merge: true });

            alert("VOD Program Notu kaydedildi!");
        }

        // ADMIN: Randevularƒ± G√∂r√ºnt√ºle
        async function showBookings() {
            const selectedDate = document.getElementById('bookingDateAdmin').value;
            const detailsDiv = document.getElementById('bookingDetails');
            detailsDiv.innerHTML = 'Y√ºkleniyor...';

            if (!selectedDate) {
                detailsDiv.innerHTML = 'L√ºtfen bir tarih se√ßin.';
                return;
            }
            
            const randevuRef = doc(db, "randevular", selectedDate);
            const docSnap = await getDoc(randevuRef);
            
            if (!docSnap.exists() || Object.keys(docSnap.data()).length === 0) {
                detailsDiv.innerHTML = `${selectedDate} tarihinde randevu bulunmamaktadƒ±r.`;
                return;
            }

            const bookingData = docSnap.data();
            let html = `<strong>${selectedDate} Randevularƒ±:</strong><br>`;

            // Alt satƒ±r karakterini (<br>) ile deƒüi≈ütirme (Admin Paneli Randevu Listesi)
            if (bookingData.programNotu && bookingData.programNotu.trim() !== "") {
                const formattedWodNote = bookingData.programNotu.replace(/\n/g, '<br>');
                html += `**VOD Program Notu:** ${formattedWodNote}<br><br>`;
            }

            const sortedTimes = Object.keys(bookingData).filter(key => key !== 'programNotu').sort();

            for (const saat of sortedTimes) {
                const participantUIDs = bookingData[saat];
                
                let names = [];
                for (const uid of participantUIDs) {
                    let userEmail = null;
                    
                    // Admin adƒ± d√ºzeltme (oturumdan √ßekme)
                    if (currentUser && uid === currentUser.uid) {
                        userEmail = currentUser.email;
                    } else {
                        const userDoc = await getDoc(doc(db, "uyeler", uid));
                        if (userDoc.exists()) {
                            userEmail = userDoc.data().email;
                        }
                    }

                    let displayName = "Bilinmiyor";
                    
                    if (userEmail) {
                        displayName = userEmail.split('@')[0];
                    }

                    names.push(displayName);
                }
                
                html += `<strong>${saat} (${participantUIDs.length} Ki≈üi):</strong> ${names.join(', ')}<br>`;
            }

            detailsDiv.innerHTML = html;
        }
        
        // ADMIN: Yeni √úyelik A√ßma
        async function yeniUyelikAc() {
            const email = document.getElementById('newUyeEmail').value.trim();
            const password = document.getElementById('newUyePass').value;
            const bitisTarihi = document.getElementById('newUyeBitisTarihi').value;
            const statusMsg = document.getElementById('uyeOlusturmaDurum');

            if (!email || !password || !bitisTarihi) {
                statusMsg.innerText = "Hata: T√ºm alanlarƒ± doldurun.";
                return;
            }

            if (password.length < 6) {
                statusMsg.innerText = "Hata: ≈ûifre en az 6 karakter olmalƒ±dƒ±r.";
                return;
            }
            
            statusMsg.style.color = 'yellow';
            statusMsg.innerText = "Kullanƒ±cƒ± olu≈üturuluyor, l√ºtfen bekleyin...";

            try {
                // 1. Auth'ta kullanƒ±cƒ± olu≈ütur
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUid = userCredential.user.uid;
                
                // 2. Firestore'da √ºyelik belgesini olu≈ütur (BA≈ûLANGI√á TARƒ∞Hƒ∞ EKLENDƒ∞)
                await setDoc(doc(db, "uyeler", newUid), {
                    email: email,
                    rol: "uye",
                    uyelikBaslangicTarihi: bugunStr, // √úyelik ba≈ülangƒ±√ß tarihi, o g√ºn√ºn tarihi olarak kaydedildi
                    uyelikBitisTarihi: bitisTarihi
                });

                // 3. G√ºvenlik i√ßin, yeni a√ßƒ±lan kullanƒ±cƒ±nƒ±n oturumunu kapatƒ±p Admin'in tekrar giri≈ü yapmasƒ±nƒ± iste
                await signOut(auth); 
                
                statusMsg.style.color = '#00e676';
                statusMsg.innerText = `‚úÖ Ba≈üarƒ±lƒ±! ${email} hesabƒ± olu≈üturuldu. G√ºvenlik nedeniyle l√ºtfen Admin olarak tekrar giri≈ü yapƒ±n.`;
                
                // Alanlarƒ± temizle
                document.getElementById('newUyeEmail').value = '';
                document.getElementById('newUyePass').value = '';
                document.getElementById('newUyeBitisTarihi').value = '';

            } catch (error) {
                let errorMessage = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Bu e-posta adresi zaten kullanƒ±mda.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Ge√ßersiz e-posta formatƒ±.";
                }
                
                statusMsg.style.color = '#ff5252';
                statusMsg.innerText = `Hata: ${errorMessage}`;
            }
        }

        // ADMIN: √úye S√ºresini E-posta ile G√ºncelle
        async function uyeSuresiGuncelle() {
            const email = document.getElementById('uyeEmailAdmin').value;
            const tarih = document.getElementById('uyeBitisTarihiAdmin').value;
            
            if(!email || !tarih) return alert("E-posta ve Tarih giriniz.");

            const q = query(collection(db, "uyeler"), where("email", "==", email));
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    return alert(`Hata: ${email} adresine kayƒ±tlƒ± √ºye bulunamadƒ±.`);
                }

                let targetUid = null;
                querySnapshot.forEach((doc) => {
                    targetUid = doc.id;
                });
                
                if (targetUid) {
                    await updateDoc(doc(db, "uyeler", targetUid), {
                        uyelikBitisTarihi: tarih
                    });
                    alert(`${email} adresli √ºyenin s√ºresi ${tarih} tarihine kadar uzatƒ±ldƒ±.`);
                }
            } catch (e) {
                alert(`ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu. L√ºtfen Geli≈ütirici Konsolunu (F12) kontrol edin.`);
                console.error("Firestore Sorgu Hatasƒ±:", e);
            }
        }


        // --- EVENT LISTENERS (Baƒülantƒ±lar) ---

        const loginBtn = document.getElementById('loginBtn');
        const cikisBtn = document.getElementById('cikisBtn');
        const randevuBtn = document.getElementById('randevuBtn');
        const ayarGuncelleBtn = document.getElementById('ayarGuncelleBtn');
        const showBookingsBtn = document.getElementById('showBookingsBtn');
        const uyeGuncelleBtn = document.getElementById('uyeGuncelleBtn');
        const wodKaydetBtn = document.getElementById('wodKaydetBtn');
        const yeniUyelikAcBtn = document.getElementById('yeniUyelikAcBtn');

        if(loginBtn) loginBtn.addEventListener('click', girisYap);
        if(cikisBtn) cikisBtn.addEventListener('click', cikisYap);
        if(randevuBtn) randevuBtn.addEventListener('click', randevuAl);
        
        if(ayarGuncelleBtn) ayarGuncelleBtn.addEventListener('click', ayarGuncelle);
        if(showBookingsBtn) showBookingsBtn.addEventListener('click', showBookings);
        if(uyeGuncelleBtn) uyeGuncelleBtn.addEventListener('click', uyeSuresiGuncelle);
        if(wodKaydetBtn) wodKaydetBtn.addEventListener('click', wodKaydet);
        if(yeniUyelikAcBtn) yeniUyelikAcBtn.addEventListener('click', yeniUyelikAc);

    </script>
</body>
</html>